import requests
import base64
import json
import time
from picamera2 import Picamera2
from datetime import datetime
import os
import RPi.GPIO as GPIO
import threading

# Set custom media directory
MEDIA_DIR = "/home/rpi5/CamTry/Photos_Vids"
os.makedirs(MEDIA_DIR, exist_ok=True)

def timestamp():
    return datetime.now().strftime("%Y%m%d_%H%M%S")

class ExitParkingSystemWithOCR:
    def __init__(self, server_url, cam_index=0):
        self.server_url = server_url
        self.cam_index = cam_index
        self.camera = None
        self.current_entry_id = None  # Store entry ID for confirmation
        self.current_plate = None     # Store extracted plate number
        self.pwm = None
        self.setup_camera()
        self.setup_servo()
    
    def setup_camera(self):
        """Initialize camera"""
        try:
            self.camera = Picamera2(self.cam_index)
            # Configure camera for better plate reading
            config = self.camera.create_still_configuration(
                main={"size": (1920, 1080)},
                lores={"size": (640, 480)},
                display="lores"
            )
            self.camera.configure(config)
            self.camera.start()
            time.sleep(2)  # Let camera warm up
            print(f"[{timestamp()}] üì∑ EXIT CAMERA {self.cam_index}: Initialized successfully")
        except Exception as e:
            print(f"[{timestamp()}] ‚ùå Camera {self.cam_index} setup failed: {e}")
    
    def setup_servo(self):
        """Initialize servo motor for exit gate control"""
        try:
            self.servo_pin = 13
            self.pwm_frequency = 50
            GPIO.setmode(GPIO.BCM)
            GPIO.setup(self.servo_pin, GPIO.OUT)
            self.pwm = GPIO.PWM(self.servo_pin, self.pwm_frequency)
            self.pwm.start(0)
            
            # Initialize gate to closed position
            self.set_angle(0)
            print(f"[{timestamp()}] üö™ EXIT GATE (Camera {self.cam_index}): Initialized - Gate Closed")
        except Exception as e:
            print(f"[{timestamp()}] ‚ùå Servo setup failed: {e}")
    
    def set_angle(self, angle):
        """Set servo angle (0 = closed, 90 = open)"""
        try:
            duty_cycle = 2 + (angle/18)
            self.pwm.ChangeDutyCycle(duty_cycle)
            time.sleep(0.5)  # Give servo time to move
            self.pwm.ChangeDutyCycle(0)  # Stop sending signal
        except Exception as e:
            print(f"[{timestamp()}] ‚ùå Error setting servo angle: {e}")
    
    def open_gate(self):
        """Open the exit gate"""
        self.set_angle(90)
        print(f"[{timestamp()}] üü¢ EXIT GATE (Camera {self.cam_index}): OPENED ‚úÖ")
    
    def close_gate(self):
        """Close the exit gate"""
        self.set_angle(0)
        print(f"[{timestamp()}] üî¥ EXIT GATE (Camera {self.cam_index}): CLOSED ‚úÖ")
    
    def exit_gate_cycle_with_confirmation(self, entry_id, plate_number):
        """
        Complete exit cycle: Open gate ‚Üí Wait 10 seconds ‚Üí Close gate ‚Üí Wait 5 seconds ‚Üí Confirm exit
        """
        def gate_operation():
            try:
                print(f"[{timestamp()}] üöó STARTING EXIT SEQUENCE FOR: {plate_number} (Camera {self.cam_index})")
                print("=" * 50)
                
                # Step 1: Open gate
                print(f"[{timestamp()}] üîì STEP 1: Opening exit gate...")
                self.open_gate()
                
                # Step 2: Keep gate open for 10 seconds
                print(f"[{timestamp()}] ‚è±Ô∏è  STEP 2: Gate open - Vehicle has 10 seconds to exit...")
                for i in range(10, 0, -1):
                    print(f"   ‚è≥ {i} seconds remaining...")
                    time.sleep(1)
                
                # Step 3: Close gate
                print(f"[{timestamp()}] üîí STEP 3: Closing exit gate...")
                self.close_gate()
                
                # Step 4: Wait 5 seconds before confirming exit
                print(f"[{timestamp()}] ‚è±Ô∏è  STEP 4: Waiting 5 seconds before confirming exit...")
                for i in range(5, 0, -1):
                    print(f"   ‚è≥ {i} seconds until exit confirmation...")
                    time.sleep(1)
                
                # Step 5: Confirm exit to server
                print(f"[{timestamp()}] üì° STEP 5: Confirming exit with server...")
                success = self.confirm_vehicle_exit(entry_id, plate_number)
                
                if success:
                    print(f"[{timestamp()}] ‚úÖ EXIT COMPLETE: {plate_number} has successfully exited!")
                    print(f"[{timestamp()}] üìã Parking session closed.")
                else:
                    print(f"[{timestamp()}] ‚ö†Ô∏è  EXIT WARNING: Could not confirm exit for {plate_number}")
                    print(f"[{timestamp()}]    (Vehicle may have exited but server confirmation failed)")
                
                print("=" * 50)
                
            except Exception as e:
                print(f"[{timestamp()}] ‚ùå EXIT SEQUENCE ERROR: {e}")
                # Emergency: Ensure gate is closed
                try:
                    print(f"[{timestamp()}] üö® Emergency: Ensuring gate is closed...")
                    self.close_gate()
                except:
                    pass
        
        # Run complete exit sequence in separate thread
        gate_thread = threading.Thread(target=gate_operation)
        gate_thread.daemon = True
        gate_thread.start()
        return gate_thread
    
    def capture_image(self):
        """Capture high-quality image for plate recognition"""
        try:
            # Capture image with timestamp
            ts = timestamp()
            filename = f"{MEDIA_DIR}/exit_cam{self.cam_index}_{ts}.jpg"
            
            # Take picture
            self.camera.capture_file(filename)
            print(f"[{timestamp()}] üì∑ EXIT IMAGE (Camera {self.cam_index}): Captured exit_cam{self.cam_index}_{ts}.jpg")
            
            return filename
        except Exception as e:
            print(f"[{timestamp()}] ‚ùå Failed to capture exit image on camera {self.cam_index}: {e}")
            return None
    
    def process_exit_with_ocr(self, image_path, color="unknown"):
        """
        Send image to server for OCR processing and payment verification
        """
        try:
            print(f"[{timestamp()}] üì° PROCESSING: Sending image to server for plate extraction...")
            
            # Read and encode image
            with open(image_path, 'rb') as image_file:
                image_data = base64.b64encode(image_file.read()).decode('utf-8')
            
            # Prepare data for server
            data = {
                'image': image_data,
                'color': color,
                'camera_name': f'exit_cam_{self.cam_index}',
                'timestamp': datetime.now().isoformat()
            }
            
            # Send to server for OCR and payment verification
            url = f"{self.server_url}/api/process-exit/"
            print(f"[{timestamp()}] üî§ OCR: Extracting plate number...")
            
            response = requests.post(url, json=data, timeout=45)  # Increased timeout for OCR
            
            # Clean up local file
            os.remove(image_path)
            print(f"[{timestamp()}] üóëÔ∏è  Cleaned up local image file")
            
            # Process server response
            if response.status_code == 200:
                # SUCCESS - Payment verified, gate should open
                result = response.json()
                extracted_plate = result.get('plate_number', 'Unknown')
                confidence = result.get('confidence', 0)
                
                print(f"[{timestamp()}] ‚úÖ SUCCESS - EXIT AUTHORIZED!")
                print(f"[{timestamp()}] üî§ PLATE: {extracted_plate} (OCR Confidence: {confidence}%)")
                print(f"[{timestamp()}] üí∞ FEE PAID: Ksh {result['parking_fee']}")
                print(f"[{timestamp()}] ‚è±Ô∏è  DURATION: {result['duration']}")
                
                # Store details for confirmation
                self.current_entry_id = result['entry_id']
                self.current_plate = extracted_plate
                
                return True, result
                
            elif response.status_code == 403:
                # PAYMENT REQUIRED
                result = response.json()
                extracted_plate = result.get('plate_number', 'Unknown')
                confidence = result.get('confidence', 0)
                
                print(f"[{timestamp()}] ‚ùå EXIT DENIED - PAYMENT REQUIRED!")
                print(f"[{timestamp()}] üî§ PLATE: {extracted_plate} (OCR Confidence: {confidence}%)")
                print(f"[{timestamp()}] üí≥ PAYMENT DUE: Ksh {result.get('parking_fee', 'Unknown')}")
                print(f"[{timestamp()}] ‚è±Ô∏è  DURATION: {result.get('duration', 'Unknown')}")
                print(f"[{timestamp()}] üöó TYPE: {result.get('vehicle_type', 'Unknown')}")
                print(f"[{timestamp()}] üí° Please complete payment before attempting to exit")
                
                return False, result
                
            elif response.status_code == 404:
                # NO ACTIVE ENTRY FOUND
                result = response.json()
                extracted_plate = result.get('extracted_plate', 'Unknown')
                confidence = result.get('confidence', 0)
                
                print(f"[{timestamp()}] ‚ùå EXIT DENIED - NO ACTIVE ENTRY!")
                print(f"[{timestamp()}] üî§ EXTRACTED PLATE: {extracted_plate} (OCR Confidence: {confidence}%)")
                print(f"[{timestamp()}] üìã No active parking session found for this plate")
                print(f"[{timestamp()}] üí° Vehicle may have already exited or plate recognition failed")
                
                return False, result
                
            elif response.status_code == 400:
                # OCR FAILED
                result = response.json()
                print(f"[{timestamp()}] ‚ùå EXIT DENIED - PLATE RECOGNITION FAILED!")
                print(f"[{timestamp()}] üî§ Could not extract plate number from image")
                print(f"[{timestamp()}] üí° Ensure license plate is clearly visible and well-lit")
                
                return False, result
                
            else:
                # SERVER ERROR
                print(f"[{timestamp()}] ‚ùå SERVER ERROR: {response.status_code}")
                print(f"[{timestamp()}] Response: {response.text}")
                return False, {"error": "Server error"}
                
        except Exception as e:
            print(f"[{timestamp()}] ‚ùå Error processing exit: {e}")
            return False, {"error": str(e)}
    
    def confirm_vehicle_exit(self, entry_id, plate_number):
        """Confirm to server that vehicle has completed exit"""
        try:
            data = {
                'entry_id': entry_id,
                'plate_number': plate_number
            }
            
            url = f"{self.server_url}/api/confirm-exit/"
            response = requests.post(url, json=data, timeout=15)
            
            if response.status_code == 200:
                result = response.json()
                print(f"[{timestamp()}] ‚úÖ SERVER CONFIRMED: {result['message']}")
                return True
            else:
                print(f"[{timestamp()}] ‚ùå Confirmation failed: {response.text}")
                return False
                
        except Exception as e:
            print(f"[{timestamp()}] ‚ùå Error confirming exit: {e}")
            return False
    
    def run_exit_monitoring(self, interval=20, duration=300):
        """Run exit monitoring for specified duration"""
        print(f"[{timestamp()}] üöÄ STARTING EXIT MONITORING SYSTEM (Camera {self.cam_index})")
        print("=" * 60)
        print(f"[{timestamp()}] üì∑ System will capture images and extract plate numbers")
        print(f"[{timestamp()}] üî§ OCR processing will identify vehicles")
        print(f"[{timestamp()}] üí≥ Payment status will be verified from database")
        print(f"[{timestamp()}] üö™ Gate opens ONLY for vehicles with completed payments")
        print(f"[{timestamp()}] ‚è±Ô∏è  Exit sequence: Open 10s ‚Üí Close ‚Üí Wait 5s ‚Üí Confirm")
        print(f"[{timestamp()}] üîÑ Scanning every {interval} seconds for {duration} seconds")
        print("=" * 60)
        
        start_time = time.time()
        
        try:
            scan_count = 0
            while time.time() - start_time < duration:
                scan_count += 1
                print(f"\n[{timestamp()}] üîç SCAN #{scan_count} - Camera {self.cam_index}")
                print("-" * 40)
                
                # Step 1: Capture image
                print(f"[{timestamp()}] üì∑ Capturing exit image...")
                image_path = self.capture_image()
                
                if image_path:
                    # Step 2: Process with OCR and payment verification
                    success, result = self.process_exit_with_ocr(image_path)
                    
                    if success:
                        # Step 3: Payment verified - Start exit sequence
                        print(f"[{timestamp()}] üéØ PAYMENT VERIFIED - INITIATING EXIT SEQUENCE")
                        self.exit_gate_cycle_with_confirmation(
                            self.current_entry_id, 
                            self.current_plate
                        )
                        
                        # Give extra time for the exit sequence to complete
                        print(f"[{timestamp()}] ‚è≥ Exit sequence running... Next scan in {interval + 20} seconds")
                        time.sleep(interval + 20)
                    else:
                        # Payment not verified or other error
                        error_msg = result.get('error', 'Unknown error')
                        print(f"[{timestamp()}] üö´ GATE REMAINS CLOSED: {error_msg}")
                        
                        print(f"[{timestamp()}] ‚è≥ Next scan in {interval} seconds")
                        time.sleep(interval)
                else:
                    print(f"[{timestamp()}] ‚ùå IMAGE CAPTURE FAILED")
                    print(f"[{timestamp()}] ‚è≥ Next scan in {interval} seconds")
                    time.sleep(interval)
                
        except Exception as e:
            print(f"[{timestamp()}] ‚ùå Error in exit monitoring: {e}")
        finally:
            self.cleanup()
    
    def cleanup(self):
        """Clean up all resources"""
        try:
            print(f"[{timestamp()}] üßπ CLEANUP: Shutting down exit system...")
            
            # Ensure gate is closed
            print(f"[{timestamp()}] üö™ Ensuring exit gate is closed...")
            self.close_gate()
            time.sleep(1)
            
            # Stop camera
            if self.camera:
                self.camera.stop()
                print(f"[{timestamp()}] üì∑ Camera {self.cam_index} stopped")
            
            # Clean up GPIO
            if self.pwm:
                self.pwm.stop()
            GPIO.cleanup()
            print(f"[{timestamp()}] üîå GPIO cleaned up")
            print(f"[{timestamp()}] ‚úÖ Exit system shutdown complete")
            
        except Exception as e:
            print(f"[{timestamp()}] ‚ùå Error during cleanup: {e}")

def main():
    print(f"[{timestamp()}] Exit Parking System Script started.")
    
    server_url = "http://192.168.100.3:8000"
    exit_system = ExitParkingSystemWithOCR(server_url, cam_index=0)  # Use camera 0
    
    print(f"[{timestamp()}] Starting Exit Camera 0 for 300 seconds...")
    
    # Create and start thread for camera 0 (exit system)
    cam_0 = threading.Thread(target=exit_system.run_exit_monitoring, args=(20, 300))
    cam_0.start()
    cam_0.join()
    
    print(f"[{timestamp()}] Exit monitoring complete.")

if __name__ == "__main__":
    main()
